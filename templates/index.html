<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TJMX2 - Standings & Games</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="container">
    <h1>‚öæ TJMX2</h1>
    <p class="muted">Standings and Today Games</p>

    <div id="loading">Loading data, please wait‚Ä¶</div>
    <div id="error" class="hidden"></div>
    <div id="last-updated" class="muted hidden"></div>

  <section id="standings-section" class="hidden">
  <h2>üèÜ Standings</h2>
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Team</th>
          <th>Player</th>
          <th class="num">W</th>
          <th class="num">L</th>
          <th class="num">Pts</th>
        </tr>
      </thead>
      <tbody id="standings-body"></tbody>
    </table>
  </div>
</section>


    <section id="games-today-section" class="hidden">
      <h2>üìÖ Today Games</h2>
      <ul id="games-today-list" class="games-list"></ul>
      
      <div class="homerun-link-wrapper">
        <a href="https://tjmx-2.onrender.com/" target="_blank" class="homerun-button">
          ---
        </a>
      </div>
    </section>
      

  </div>

  <script>
    const el = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      updated: document.getElementById('last-updated'),
      standingsSection: document.getElementById('standings-section'),
      standingsBody: document.getElementById('standings-body'),
      gamesSection: document.getElementById('games-today-section'),
      gamesList: document.getElementById('games-today-list')
      // history elements se obtienen din√°micamente
    };
    const show = x => x.classList.remove('hidden');
    const hide = x => x.classList.add('hidden');

    function parseGameString(s) {
      if (!s) return { raw: '' };
      const cleaned = s.trim().replace(/\s+/g, ' ');
      const match = cleaned.match(/^(.*?) (\d+)\s*-\s*(\d+) (.*?)\s*(?:-\s*(.*))?$/);
      if (match) {
        return {
          home_team: match[1],
          home_score: match[2],
          away_score: match[3],
          away_team: match[4],
          ended_at_local: match[5] ? match[5] : ''
        };
      }
      return { raw: cleaned };
    }

    function formatToET(dateText) {
      if (!dateText) return '';
      const clean = dateText.replace(/\(.*hora.*\)/i, '').trim();
      const tryDate = new Date(clean.replace(' ', 'T'));
      if (isNaN(tryDate)) return clean;
      const adjusted = new Date(tryDate.getTime() - 1 * 60 * 60 * 1000);
      const opts = {
        timeZone: 'America/New_York',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      };
      return adjusted.toLocaleString('en-US', opts) + ' ET';
    }

    async function loadData(){
      hide(el.error);
      show(el.loading);
      try{
        const r = await fetch('/api/full', {cache:'no-store'});
        if(!r.ok){
          let msg = `HTTP ${r.status}`;
          try{ const j = await r.json(); if (j && j.error) msg = j.error; }catch(_){}
          throw new Error(msg);
        }
        const data = await r.json();

        // ‚úÖ Last Update en hora del Este (+3 horas)
        if (data.last_updated) {
          const utcDate = new Date(data.last_updated.replace(' ', 'T') + 'Z');
          const adjustedDate = new Date(utcDate.getTime() + 0 * 60 * 60 * 1000);
          const options = {
            timeZone: 'America/New_York',
            year: 'numeric',
            month: 'short',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          };
          const etTime = adjustedDate.toLocaleString('en-US', options);
          el.updated.textContent = `Last Update: ${etTime} ET`;
          show(el.updated);
        }

        // ‚úÖ Standings
        el.standingsBody.innerHTML = '';
        (data.standings || []).forEach((row, i) => {
          const tr = document.createElement('tr');
          if (i < 8) tr.classList.add('highlight');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td class="team-name">${row.team}</td>
            <td><span class="tag">${row.user}</span></td>
            <td class="num">${row.wins}</td>
            <td class="num">${row.losses}</td>
            <td class="num pts">${row.points}</td>
          `;
          el.standingsBody.appendChild(tr);
        });
        show(el.standingsSection);

        // ‚úÖ Today Games - detecci√≥n autom√°tica
        el.gamesList.innerHTML = '';
        const games = Array.isArray(data.games_today) ? data.games_today : [];
        if (games.length === 0) {
          el.gamesList.innerHTML = `<li class="muted">No games completed today.</li>`;
        } else {
          for (const g of games) {
            const li = document.createElement('li');
            let text = typeof g === 'string' ? g.trim() : '';

            // Ejemplo: "Tigers 2 - Mariners 9 - 16-10-2025 - 11:09 pm ET"
            const regex = /^([\w\s]+)\s+(\d+)\s*-\s*([\w\s]+)\s+(\d+)\s*-\s*(\d{2}-\d{2}-\d{4})\s*-\s*(.*)$/i;
            const match = text.match(regex);

            if (match) {
              const homeTeam = match[1].trim();
              const homeScore = parseInt(match[2]);
              const awayTeam = match[3].trim();
              const awayScore = parseInt(match[4]);
              const datePart = match[5];
              const timePart = match[6];

              let homeClass = 'team';
              let awayClass = 'team';
              if (homeScore > awayScore) {
                homeClass += ' winner';
                awayClass += ' loser';
              } else if (awayScore > homeScore) {
                awayClass += ' winner';
                homeClass += ' loser';
              }

              li.innerHTML = `
                <div class="game-line">
                  <span class="${homeClass}">${homeTeam}</span>
                  <span class="score">${homeScore}</span>
                  <span>-</span>
                  <span class="score">${awayScore}</span>
                  <span class="${awayClass}" style="text-align:right;">${awayTeam}</span>
                </div>
                <div class="game-time">üïí ${datePart} - ${timePart}</div>
              `;
            } else {
              li.textContent = text;
            }

            el.gamesList.appendChild(li);
          }
        }
        show(el.gamesSection);



      }catch(e){
        el.error.textContent = 'Unable to load data: ' + e.message;
        show(el.error);
      }finally{
        hide(el.loading);
      }
    }

    loadData();
  </script>
</body>
</html>
